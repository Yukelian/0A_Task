#include "bsp_w25xx.h"
#include "stm32h7xx_hal.h"
#include "spi.h"
#include <string.h>

/* ????Flash????GPIO???? PA4  */
#define SF_CS_CLK_ENABLE() __HAL_RCC_GPIOA_CLK_ENABLE()
#define SF_CS_GPIO FLASH_CS_GPIO_Port
#define SF_CS_PIN FLASH_CS_Pin

#define SF_CS_0() SF_CS_GPIO->BSRR = ((uint32_t)SF_CS_PIN << 16U)
#define SF_CS_1() SF_CS_GPIO->BSRR = SF_CS_PIN

#define hspi hspi3

#define CMD_AAI 0xAD	/* AAI ??????????(FOR SST25VF016B) */
#define CMD_DISWR 0x04	/* ???§Õ, ???AAI?? */
#define CMD_EWRSR 0x50	/* ????§Õ????????????? */
#define CMD_WRSR 0x01	/* §Õ??????????? */
#define CMD_WREN 0x06	/* §Õ??????? */
#define CMD_READ 0x03	/* ???????????? */
#define CMD_RDSR 0x05	/* ????????????? */
#define CMD_RDID 0x9F	/* ??????ID???? */
#define CMD_SE 0x20		/* ???????????? */
#define CMD_BE 0xC7		/* ???????????? */
#define DUMMY_BYTE 0xA5 /* ??????????????????????????? */
#define WIP_FLAG 0x01	/* ????????§Ö???????????WIP) */

SFLASH_T g_tSF;

uint32_t g_spiLen;

#define SPI_BUFFER_SIZE (4 * 1024)

uint8_t g_spiTxBuf[SPI_BUFFER_SIZE];
uint8_t g_spiRxBuf[SPI_BUFFER_SIZE];

static uint8_t s_spiBuf[4 * 1024]; /* ????§Õ???????????????????????????????????????????§Õ */
static void W25xx_WriteEnable(void);
static void W25xx_WaitForWriteEnd(void);
static uint8_t W25xx_NeedErase(uint8_t *_ucpOldBuf, uint8_t *_ucpNewBuf, uint16_t _uiLen);
static uint8_t W25xx_CmpData(uint32_t _uiSrcAddr, uint8_t *_ucpTar, uint32_t _uiSize);
static uint8_t W25xx_AutoWriteSector(uint8_t *_ucpSrc, uint32_t _uiWrAddr, uint16_t _usWrLen);

/*
*********************************************************************************************************
*	?? ?? ??: bsp_spiTransfer
*	???????: ???????????
*	??    ??: ??
*	?? ?? ?: ??
*********************************************************************************************************
*/
void bsp_spiTransfer(void)
{
	HAL_StatusTypeDef result;
	result = HAL_SPI_TransmitReceive(&hspi, (uint8_t *)g_spiTxBuf, (uint8_t *)g_spiRxBuf, g_spiLen, 1000);
	if (result != HAL_OK)
	{
		// Error_Handler(__FILE__, __LINE__);
	}
}

/*
*********************************************************************************************************
*	?? ?? ??: bsp_InitSFlash
*	???????: ????falsh?????????? ????CS GPIO?? ???ID??
*	??    ??: ??
*	?? ?? ?: ??
*********************************************************************************************************
*/
void bsp_InitSFlash(void)
{
	/* ???§à?ID, ??????§à???? */
	W25xx_ReadInfo();
}

/*
*********************************************************************************************************
*	?? ?? ??: sf_SetCS
*	???????: ????FALSH?????????
*	??    ??: ??
*	?? ?? ?: ??
*********************************************************************************************************
*/
void sf_SetCS(uint8_t _Level)
{
	if (_Level == 0)
	{
		SF_CS_0();
	}
	else
	{
		SF_CS_1();
	}
}

/*
*********************************************************************************************************
*	?? ?? ??: sf_EraseSector
*	???????: ?????????????
*	??    ??: _uiSectorAddr : ???????
*	?? ?? ?: ??
*********************************************************************************************************
*/
void W25xx_EraseSector(uint32_t _uiSectorAddr)
{
	W25xx_WriteEnable(); /* ????§Õ??????? */

	/* ???????????? */
	sf_SetCS(0); /* ????? */
	g_spiLen = 0;
	g_spiTxBuf[g_spiLen++] = CMD_SE;							 /* ??????????? */
	g_spiTxBuf[g_spiLen++] = ((_uiSectorAddr & 0xFF0000) >> 16); /* ??????????????8bit */
	g_spiTxBuf[g_spiLen++] = ((_uiSectorAddr & 0xFF00) >> 8);	 /* ????????????§Þ?8bit */
	g_spiTxBuf[g_spiLen++] = (_uiSectorAddr & 0xFF);			 /* ?????????????8bit */
	bsp_spiTransfer();
	sf_SetCS(1); /* ?????? */

	W25xx_WaitForWriteEnd(); /* ???????Flash???§Õ??????? */
}

/*
*********************************************************************************************************
*	?? ?? ??: sf_EraseChip
*	???????: ????????§à?
*	??    ??:  ??
*	?? ?? ?: ??
*********************************************************************************************************
*/
void W25xx_EraseChip(void)
{
	W25xx_WriteEnable(); /* ????§Õ??????? */

	/* ???????????? */
	sf_SetCS(0); /* ????? */
	g_spiLen = 0;
	g_spiTxBuf[g_spiLen++] = CMD_BE; /* ??????????????? */
	bsp_spiTransfer();
	sf_SetCS(1); /* ?????? */

	W25xx_WaitForWriteEnd(); /* ???????Flash???§Õ??????? */
}

/*
*********************************************************************************************************
*	?? ?? ??: sf_PageWrite
*	???????: ?????
*	??    ??: _pBuf : ?????????????
*			  _uiWriteAddr ???????????????
*			  _usSize ??????????????§³??????????256????????????
*	?? ?? ?: ??
*********************************************************************************************************
*/
void W25xx_PageWrite(uint8_t *_pBuf, uint32_t _uiWriteAddr, uint16_t _usSize)
{
	uint32_t i, j;

	if (g_tSF.ChipID == SST25VF016B_ID)
	{
		/* AAI????????????????????? */
		if ((_usSize < 2) && (_usSize % 2))
		{
			return;
		}

		W25xx_WriteEnable(); /* ????§Õ??????? */

		sf_SetCS(0); /* ????? */
		g_spiLen = 0;
		g_spiTxBuf[g_spiLen++] = CMD_AAI;							/* ????AAI????(????????????) */
		g_spiTxBuf[g_spiLen++] = ((_uiWriteAddr & 0xFF0000) >> 16); /* ??????????????8bit */
		g_spiTxBuf[g_spiLen++] = ((_uiWriteAddr & 0xFF00) >> 8);	/* ????????????§Þ?8bit */
		g_spiTxBuf[g_spiLen++] = (_uiWriteAddr & 0xFF);				/* ?????????????8bit */
		g_spiTxBuf[g_spiLen++] = (*_pBuf++);						/* ?????1?????? */
		g_spiTxBuf[g_spiLen++] = (*_pBuf++);						/* ?????2?????? */
		bsp_spiTransfer();
		sf_SetCS(1); /* ?????? */

		W25xx_WaitForWriteEnd(); /* ???????Flash???§Õ??????? */

		_usSize -= 2; /* ???????????? */

		for (i = 0; i < _usSize / 2; i++)
		{
			sf_SetCS(0); /* ????? */
			g_spiLen = 0;
			g_spiTxBuf[g_spiLen++] = (CMD_AAI);	 /* ????AAI????(????????????) */
			g_spiTxBuf[g_spiLen++] = (*_pBuf++); /* ???????? */
			g_spiTxBuf[g_spiLen++] = (*_pBuf++); /* ???????? */
			bsp_spiTransfer();
			sf_SetCS(1);			 /* ?????? */
			W25xx_WaitForWriteEnd(); /* ???????Flash???§Õ??????? */
		}

		/* ????§Õ?????? */
		sf_SetCS(0);
		g_spiLen = 0;
		g_spiTxBuf[g_spiLen++] = (CMD_DISWR);
		bsp_spiTransfer();
		sf_SetCS(1);

		W25xx_WaitForWriteEnd(); /* ???????Flash???§Õ??????? */
	}
	else /* for MX25L1606E ?? W25Q64BV */
	{
		for (j = 0; j < _usSize / 256; j++)
		{
			W25xx_WriteEnable(); /* ????§Õ??????? */

			sf_SetCS(0); /* ????? */
			g_spiLen = 0;
			g_spiTxBuf[g_spiLen++] = (0x02);							/* ????AAI????(????????????) */
			g_spiTxBuf[g_spiLen++] = ((_uiWriteAddr & 0xFF0000) >> 16); /* ??????????????8bit */
			g_spiTxBuf[g_spiLen++] = ((_uiWriteAddr & 0xFF00) >> 8);	/* ????????????§Þ?8bit */
			g_spiTxBuf[g_spiLen++] = (_uiWriteAddr & 0xFF);				/* ?????????????8bit */
			for (i = 0; i < 256; i++)
			{
				g_spiTxBuf[g_spiLen++] = (*_pBuf++); /* ???????? */
			}
			bsp_spiTransfer();
			sf_SetCS(1); /* ????? */

			W25xx_WaitForWriteEnd(); /* ???????Flash???§Õ??????? */

			_uiWriteAddr += 256;
		}

		/* ????§Õ?????? */
		sf_SetCS(0);
		g_spiLen = 0;
		g_spiTxBuf[g_spiLen++] = (CMD_DISWR);
		bsp_spiTransfer();
		sf_SetCS(1);

		W25xx_WaitForWriteEnd(); /* ???????Flash???§Õ??????? */
	}
}

/*
*********************************************************************************************************
*	?? ?? ??: sf_ReadBuffer
*	???????: ????????????????????????????§à???????
*	??    ??:  	_pBuf : ?????????????
*				_uiReadAddr ??????
*				_usSize ?????????, ???????§à???????
*	?? ?? ?: ??
*********************************************************************************************************
*/
void W25xx_ReadBuffer(uint8_t *_pBuf, uint32_t _uiReadAddr, uint32_t _uiSize)
{
	uint16_t rem;
	uint16_t i;

	/* ????????????????0???????????Flash?????????????? */
	if ((_uiSize == 0) || (_uiReadAddr + _uiSize) > g_tSF.TotalSize)
	{
		return;
	}

	/* ???????????? */
	sf_SetCS(0); /* ????? */
	g_spiLen = 0;
	g_spiTxBuf[g_spiLen++] = (CMD_READ);					   /* ????????? */
	g_spiTxBuf[g_spiLen++] = ((_uiReadAddr & 0xFF0000) >> 16); /* ??????????????8bit */
	g_spiTxBuf[g_spiLen++] = ((_uiReadAddr & 0xFF00) >> 8);	   /* ????????????§Þ?8bit */
	g_spiTxBuf[g_spiLen++] = (_uiReadAddr & 0xFF);			   /* ?????????????8bit */
	bsp_spiTransfer();

	/* ????????????????DMA??????????????????? */
	for (i = 0; i < _uiSize / SPI_BUFFER_SIZE; i++)
	{
		g_spiLen = SPI_BUFFER_SIZE;
		bsp_spiTransfer();

		memcpy(_pBuf, g_spiRxBuf, SPI_BUFFER_SIZE);
		_pBuf += SPI_BUFFER_SIZE;
	}

	rem = _uiSize % SPI_BUFFER_SIZE; /* ?????? */
	if (rem > 0)
	{
		g_spiLen = rem;
		bsp_spiTransfer();

		memcpy(_pBuf, g_spiRxBuf, rem);
	}

	sf_SetCS(1); /* ?????? */
}

/*
*********************************************************************************************************
*	?? ?? ??: sf_CmpData
*	???????: ???Flash???????
*	??    ??:  	_ucpTar : ???????????
*				_uiSrcAddr ??Flash?????
*				_uiSize ?????????, ???????§à?????????
*	?? ?? ?: 0 = ???, 1 = ????
*********************************************************************************************************
*/
static uint8_t W25xx_CmpData(uint32_t _uiSrcAddr, uint8_t *_ucpTar, uint32_t _uiSize)
{
	uint16_t i, j;
	uint16_t rem;

	/* ????????????????0???????????Flash?????????????? */
	if ((_uiSrcAddr + _uiSize) > g_tSF.TotalSize)
	{
		return 1;
	}

	if (_uiSize == 0)
	{
		return 0;
	}

	sf_SetCS(0); /* ????? */
	g_spiLen = 0;
	g_spiTxBuf[g_spiLen++] = (CMD_READ);					  /* ????????? */
	g_spiTxBuf[g_spiLen++] = ((_uiSrcAddr & 0xFF0000) >> 16); /* ??????????????8bit */
	g_spiTxBuf[g_spiLen++] = ((_uiSrcAddr & 0xFF00) >> 8);	  /* ????????????§Þ?8bit */
	g_spiTxBuf[g_spiLen++] = (_uiSrcAddr & 0xFF);			  /* ?????????????8bit */
	bsp_spiTransfer();

	/* ????????????????DMA??????????????????? */
	for (i = 0; i < _uiSize / SPI_BUFFER_SIZE; i++)
	{
		g_spiLen = SPI_BUFFER_SIZE;
		bsp_spiTransfer();

		for (j = 0; j < SPI_BUFFER_SIZE; j++)
		{
			if (g_spiRxBuf[j] != *_ucpTar++)
			{
				goto NOTEQ; /* ????? */
			}
		}
	}

	rem = _uiSize % SPI_BUFFER_SIZE; /* ?????? */
	if (rem > 0)
	{
		g_spiLen = rem;
		bsp_spiTransfer();

		for (j = 0; j < rem; j++)
		{
			if (g_spiRxBuf[j] != *_ucpTar++)
			{
				goto NOTEQ; /* ????? */
			}
		}
	}
	sf_SetCS(1);
	return 0; /* ??? */

NOTEQ:
	sf_SetCS(1); /* ????? */
	return 1;
}

/*
*********************************************************************************************************
*	?? ?? ??: W25xx_NeedErase
*	???????: ?§Ø?§ÕPAGE??????????????
*	??    ??:   _ucpOldBuf ?? ???????
*			   _ucpNewBuf ?? ???????
*			   _uiLen ???????????
*	?? ?? ?: 0 : ??????????? 1 ?????????
*********************************************************************************************************
*/
static uint8_t W25xx_NeedErase(uint8_t *_ucpOldBuf, uint8_t *_ucpNewBuf, uint16_t _usLen)
{
	uint16_t i;
	uint8_t ucOld;

	/*
	????1????old ??, new ????
		  old    new
		  1101   0101
	~     1111
		= 0010   0101

	????2??: old ??????? new ¦Ë??
		  0010   old
	&	  0101   new
		 =0000

	????3??: ????0,???????????. ?????????????
	*/

	for (i = 0; i < _usLen; i++)
	{
		ucOld = *_ucpOldBuf++;
		ucOld = ~ucOld;

		/* ???????§Õ??: if (ucOld & (*_ucpNewBuf++) != 0) */
		if ((ucOld & (*_ucpNewBuf++)) != 0)
		{
			return 1;
		}
	}
	return 0;
}

/*
*********************************************************************************************************
*	?? ?? ??: sf_AutoWriteSector
*	???????: §Õ1????????§µ??,??????????????§Õ???¦²??????????????????????
*	??    ??:  	_pBuf : ?????????????
*				_uiWriteAddr ?????????????
*				_usSize ????????????????????????§³??
*	?? ?? ?: 0 : ???? 1 ?? ???
*********************************************************************************************************
*/
static uint8_t W25xx_AutoWriteSector(uint8_t *_ucpSrc, uint32_t _uiWrAddr, uint16_t _usWrLen)
{
	uint16_t i;
	uint16_t j;			  /* ??????? */
	uint32_t uiFirstAddr; /* ??????? */
	uint8_t ucNeedErase;  /* 1?????????? */
	uint8_t cRet;

	/* ?????0???????????,????????? */
	if (_usWrLen == 0)
	{
		return 1;
	}

	/* ????????????§à?????????? */
	if (_uiWrAddr >= g_tSF.TotalSize)
	{
		return 0;
	}

	/* ???????????????????????????? */
	if (_usWrLen > g_tSF.SectorSize)
	{
		return 0;
	}

	/* ???FLASH?§Ö???????§Ò£,??§ÕFLASH */
	W25xx_ReadBuffer(s_spiBuf, _uiWrAddr, _usWrLen);
	if (memcmp(s_spiBuf, _ucpSrc, _usWrLen) == 0)
	{
		return 1;
	}

	/* ?§Ø???????????????? */
	/* ????????????????????????¦Ë???? 1->0 ???? 0->0, ?????????,???Flash???? */
	ucNeedErase = 0;
	if (W25xx_NeedErase(s_spiBuf, _ucpSrc, _usWrLen))
	{
		ucNeedErase = 1;
	}

	uiFirstAddr = _uiWrAddr & (~(g_tSF.SectorSize - 1));

	if (_usWrLen == g_tSF.SectorSize) /* ????????????§Õ */
	{
		for (i = 0; i < g_tSF.SectorSize; i++)
		{
			s_spiBuf[i] = _ucpSrc[i];
		}
	}
	else /* ??§Õ???????? */
	{
		/* ???????????????????? */
		W25xx_ReadBuffer(s_spiBuf, uiFirstAddr, g_tSF.SectorSize);

		/* ????????????? */
		i = _uiWrAddr & (g_tSF.SectorSize - 1);
		memcpy(&s_spiBuf[i], _ucpSrc, _usWrLen);
	}

	/* §Õ????????§µ?ï????????????§Õ?????3?? */
	cRet = 0;
	for (i = 0; i < 3; i++)
	{

		/* ????????????????????????¦Ë???? 1->0 ???? 0->0, ?????????,???Flash???? */
		if (ucNeedErase == 1)
		{
			W25xx_EraseSector(uiFirstAddr); /* ????1?????? */
		}

		/* ?????????? */
		W25xx_PageWrite(s_spiBuf, uiFirstAddr, g_tSF.SectorSize);

		if (W25xx_CmpData(_uiWrAddr, _ucpSrc, _usWrLen) == 0)
		{
			cRet = 1;
			break;
		}
		else
		{
			if (W25xx_CmpData(_uiWrAddr, _ucpSrc, _usWrLen) == 0)
			{
				cRet = 1;
				break;
			}

			/* ??????????????????? */
			for (j = 0; j < 10000; j++)
				;
		}
	}

	return cRet;
}

/*
*********************************************************************************************************
*	?? ?? ??: sf_WriteBuffer
*	???????: §Õ1????????§µ??,??????????????§Õ???¦²??????????????????????
*	??    ??:  _pBuf : ?????????????
*			   _uiWrAddr ?????????????
*			   _usSize ????????????????§³???????????§à???????
*	?? ?? ?: 1 : ????? 0 ?? ???
*********************************************************************************************************
*/
uint8_t W25xx_WriteBuffer(uint8_t *_pBuf, uint32_t _uiWriteAddr, uint32_t _usWriteSize)
{
	uint32_t NumOfPage = 0, NumOfSingle = 0, Addr = 0, count = 0, temp = 0;

	Addr = _uiWriteAddr % g_tSF.SectorSize;
	count = g_tSF.SectorSize - Addr; /*?????????????*/
	NumOfPage = _usWriteSize / g_tSF.SectorSize;
	NumOfSingle = _usWriteSize % g_tSF.SectorSize; /*??????§Õ??????????????????????????*/

	if (Addr == 0) /* ????????????????  */
	{
		if (NumOfPage == 0) /* ???????§³????????§³ */
		{
			if (W25xx_AutoWriteSector(_pBuf, _uiWriteAddr, _usWriteSize) == 0)
			{
				return 0;
			}
		}
		else /* ???????????????????§³ */
		{
			while (NumOfPage--)
			{
				if (W25xx_AutoWriteSector(_pBuf, _uiWriteAddr, g_tSF.SectorSize) == 0)
				{
					return 0;
				}
				_uiWriteAddr += g_tSF.SectorSize;
				_pBuf += g_tSF.SectorSize;
			}
			if (W25xx_AutoWriteSector(_pBuf, _uiWriteAddr, NumOfSingle) == 0)
			{
				return 0;
			}
		}
	}
	else /* ??????????????????  */
	{
		if (NumOfPage == 0) /* ???????§³????????§³ */
		{
			if (NumOfSingle > count) /* (_usWriteSize + _uiWriteAddr) > SPI_FLASH_PAGESIZE */
			{
				temp = NumOfSingle - count;

				if (W25xx_AutoWriteSector(_pBuf, _uiWriteAddr, count) == 0) /*§Õ?????????????????¦Ë??*/
				{
					return 0;
				}

				_uiWriteAddr += count;
				_pBuf += count;

				if (W25xx_AutoWriteSector(_pBuf, _uiWriteAddr, temp) == 0) /*????????§Õ???????????*/
				{
					return 0;
				}
			}
			else
			{
				if (W25xx_AutoWriteSector(_pBuf, _uiWriteAddr, _usWriteSize) == 0)
				{
					return 0;
				}
			}
		}
		else /* ???????????????????§³ */
		{
			_usWriteSize -= count;
			NumOfPage = _usWriteSize / g_tSF.SectorSize;
			NumOfSingle = _usWriteSize % g_tSF.SectorSize;
			if (W25xx_AutoWriteSector(_pBuf, _uiWriteAddr, count) == 0)
			{
				return 0;
			}

			_uiWriteAddr += count;
			_pBuf += count;

			while (NumOfPage--)
			{
				if (W25xx_AutoWriteSector(_pBuf, _uiWriteAddr, g_tSF.SectorSize) == 0)
				{
					return 0;
				}
				_uiWriteAddr += g_tSF.SectorSize;
				_pBuf += g_tSF.SectorSize;
			}

			if (NumOfSingle != 0)
			{
				if (W25xx_AutoWriteSector(_pBuf, _uiWriteAddr, NumOfSingle) == 0)
				{
					return 0;
				}
			}
		}
	}
	return 1; /* ??? */
}

/*
*********************************************************************************************************
*	?? ?? ??: sf_ReadID
*	???????: ???????ID
*	??    ??:  ??
*	?? ?? ?: 32bit??????ID (???8bit??0????§¹ID¦Ë???24bit??
*********************************************************************************************************
*/
uint32_t W25xx_ReadID(void)
{
	uint32_t uiID;
	uint8_t id1, id2, id3;

	sf_SetCS(0); /* ????? */
	g_spiLen = 0;
	g_spiTxBuf[0] = (CMD_RDID); /* ?????ID???? */
	g_spiLen = 4;
	bsp_spiTransfer();

	id1 = g_spiRxBuf[1]; /* ??ID???1????? */
	id2 = g_spiRxBuf[2]; /* ??ID???2????? */
	id3 = g_spiRxBuf[3]; /* ??ID???3????? */
	sf_SetCS(1);		 /* ?????? */

	uiID = ((uint32_t)id1 << 16) | ((uint32_t)id2 << 8) | id3;

	return uiID;
}

/*
*********************************************************************************************************
*	?? ?? ??: sf_ReadInfo
*	???????: ???????ID,?????????????
*	??    ??: ??
*	?? ?? ?: ??
*********************************************************************************************************
*/
void W25xx_ReadInfo(void)
{
	/* ????????Flash??? */
	{
		g_tSF.ChipID = W25xx_ReadID(); /* §à?ID */

		switch (g_tSF.ChipID)
		{
		case SST25VF016B_ID:
			strcpy(g_tSF.ChipName, "SST25VF016B");
			g_tSF.TotalSize = 2 * 1024 * 1024; /* ?????? = 2M */
			g_tSF.SectorSize = 4 * 1024;	   /* ??????§³ = 4K */
			break;

		case MX25L1606E_ID:
			strcpy(g_tSF.ChipName, "MX25L1606E");
			g_tSF.TotalSize = 2 * 1024 * 1024; /* ?????? = 2M */
			g_tSF.SectorSize = 4 * 1024;	   /* ??????§³ = 4K */
			break;

		case W25Q16BV_ID:
			strcpy(g_tSF.ChipName, "W25Q16");
			g_tSF.TotalSize = 2 * 1024 * 1024; /* ?????? = 2M */
			g_tSF.SectorSize = 4 * 1024;	   /* ??????§³ = 4K */

			break;
		case W25Q32BV_ID:
			strcpy(g_tSF.ChipName, "W25Q32");
			g_tSF.TotalSize = 4 * 1024 * 1024; /* ?????? = 4M */
			g_tSF.SectorSize = 4 * 1024;	   /* ??????§³ = 4K */
			break;

		case W25Q64BV_ID:
			strcpy(g_tSF.ChipName, "W25Q64");
			g_tSF.TotalSize = 8 * 1024 * 1024; /* ?????? = 8M */
			g_tSF.SectorSize = 4 * 1024;	   /* ??????§³ = 4K */
			break;

		case W25Q128_ID:
			strcpy(g_tSF.ChipName, "W25Q128");
			g_tSF.TotalSize = 16 * 1024 * 1024; /* ?????? = 16M */
			g_tSF.SectorSize = 4 * 1024;		/* ??????§³ = 4K */
			break;
		case W25Q256_ID:
			strcpy(g_tSF.ChipName, "W25Q256");
			g_tSF.TotalSize = 32 * 1024 * 1024; /* ?????? = 32M */
			g_tSF.SectorSize = 4 * 1024;		/* ??????§³ = 4K */
			break;
		case W25Q512_ID:
			strcpy(g_tSF.ChipName, "W25Q512");
			g_tSF.TotalSize = 64 * 1024 * 1024; /* ?????? = 64M */
			g_tSF.SectorSize = 4 * 1024;		/* ??????§³ = 4K */
			break;
		default:
			strcpy(g_tSF.ChipName, "Unknow Flash");
			g_tSF.TotalSize = 2 * 1024 * 1024;
			g_tSF.SectorSize = 4 * 1024;
			break;
		}
	}
}

/*
*********************************************************************************************************
*	?? ?? ??: sf_WriteEnable
*	???????: ??????????§Õ???????
*	??    ??: ??
*	?? ?? ?: ??
*********************************************************************************************************
*/
static void W25xx_WriteEnable(void)
{
	sf_SetCS(0); /* ????? */
	g_spiLen = 0;
	g_spiTxBuf[g_spiLen++] = (CMD_WREN); /* ???????? */
	bsp_spiTransfer();
	sf_SetCS(1); /* ?????? */
}

/*
*********************************************************************************************************
*	?? ?? ??: sf_WaitForWriteEnd
*	???????: ????????????????????????§Õ???????
*	??    ??: ??
*	?? ?? ?: ??
*********************************************************************************************************
*/
static void W25xx_WaitForWriteEnd(void)
{
	sf_SetCS(0);				/* ????? */
	g_spiTxBuf[0] = (CMD_RDSR); /* ???????? ????????? */
	g_spiLen = 2;
	bsp_spiTransfer();
	sf_SetCS(1); /* ?????? */

	while (1)
	{
		sf_SetCS(0);				/* ????? */
		g_spiTxBuf[0] = (CMD_RDSR); /* ???????? ????????? */
		g_spiTxBuf[1] = 0;			/* ??????? */
		g_spiLen = 2;
		bsp_spiTransfer();
		sf_SetCS(1); /* ?????? */

		if ((g_spiRxBuf[1] & WIP_FLAG) != SET) /* ?§Ø??????????????¦Ë */
		{
			break;
		}
	}
}
